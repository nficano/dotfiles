#!/usr/bin/env bash
#/ Convert all JPEG/PNG images under the current directory to WebP.
#/
#/ Usage: $(basename "$0") [-h] [-v]
#/
#/ Available options:
#/    -h, --help      Print this help and exit
#/    -v, --verbose   Enable verbose output
#/
#/ Details:
#/    Recursively finds images and writes .webp versions alongside originals.

set -Eeuo pipefail
trap script.cleanup SIGINT SIGTERM ERR EXIT

source "$(dirname "$0")/../lib/bash/utils"

script_dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)

verbose=0

parse_args() {
  local remaining
  remaining=$(script.parse_common "$@")

  if [[ -n "$remaining" ]]; then
    log.error "This script does not accept positional arguments"
    script.usage 1
  fi
}

convert_image() {
  local file="$1" output
  output="${file%.*}.webp"

  cwebp -q 100 "$file" -o "$output" >/dev/null 2>&1

  (( verbose )) && log.info "Converted $file -> $output"
}

main() {
  if ! require.cmd find cwebp; then
    log.error "find and cwebp are required"
    exit 1
  fi

  log.info "Converting images to WebP"

  while IFS= read -r -d '' file; do
    convert_image "$file"
  done < <(find . \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' \) -print0)

  log.info "Conversion complete"
}

parse_args "$@"
main
