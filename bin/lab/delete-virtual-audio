    #!/usr/bin/env bash
    # macOS virtual audio cleanup (interactive + fallback-safe)
    # - Lists HAL audio drivers (Loopback, BlackHole, Soundflower, VB-Cable, ACE, etc.)
    # - Lets you select which to remove (moves to a timestamped backup folder)
    # - Resets Aggregate/Multi-Output CoreAudio devices
    # - Restarts CoreAudio
    #
    # Usage:
    #   chmod +x clean-virtual-audio.sh
    #   ./clean-virtual-audio.sh            # interactive (dry-run preview shown first)
    #   ./clean-virtual-audio.sh --apply    # skip dry-run confirmation
    #   ./clean-virtual-audio.sh --list     # just list drivers and virtual devices
    #
    set -euo pipefail

    color() { printf "\033[%sm%s\033[0m\n" "$1" "$2"; }
    info()  { color "1;34" "ℹ️  $*"; }
    warn()  { color "1;33" "⚠️  $*"; }
    good()  { color "1;32" "✅ $*"; }
    bad()   { color "1;31" "✖ $*"; }

    if [[ "$(uname -s)" != "Darwin" ]]; then
      bad "This script is for macOS only."
      exit 1
    fi

    APPLY=0
    LIST_ONLY=0
    if [[ "${1:-}" == "--apply" ]]; then
      APPLY=1
    elif [[ "${1:-}" == "--list" ]]; then
      LIST_ONLY=1
    fi

    macos_version="$(sw_vers -productVersion 2>/dev/null || true)"
    info "macOS ${macos_version:-unknown} detected"

    # Where CoreAudio HAL plugins live
    HAL_DIRS=(
      "/Library/Audio/Plug-Ins/HAL"
      "$HOME/Library/Audio/Plug-Ins/HAL"
    )

    timestamp="$(date +%Y%m%d-%H%M%S)"
    BACKUP_DIR="/Users/Shared/AudioHAL-Backup-${timestamp}"

    list_hal_drivers() {
      local any=0
      for d in "${HAL_DIRS[@]}"; do
        if [[ -d "$d" ]]; then
          shopt -s nullglob
          for driver in "$d"/*.driver; do
            if [[ $any -eq 0 ]]; then
              echo "Found HAL drivers:"
              any=1
            fi
            echo "  - ${driver}"
          done
          shopt -u nullglob
        fi
      done
      [[ $any -eq 1 ]] || echo "  (none)"
    }

    list_virtual_devices() {
      echo "Virtual/CoreAudio devices:"
      if command -v coreaudioctl >/dev/null 2>&1; then
        coreaudioctl list-devices | grep -E "Aggregate|Multi|Loopback|Virtual|BlackHole|Soundflower|ACE|VB|Voicemeeter|OBS" || true
      else
        # Fallback: query system_profiler; not perfect but useful
        system_profiler SPAudioDataType 2>/dev/null | grep -E "Aggregate|Multi|Loopback|Virtual|BlackHole|Soundflower|ACE|VB|Voicemeeter|OBS" -n || true
      fi
    }

    if [[ $LIST_ONLY -eq 1 ]]; then
      list_hal_drivers
      echo ""
      list_virtual_devices
      exit 0
    fi

    info "Scanning HAL plugin directories…"
    mapfile -t ALL_DRIVERS < <(
      for d in "${HAL_DIRS[@]}"; do
        [[ -d "$d" ]] || continue
        find "$d" -maxdepth 1 -type d -name "*.driver" 2>/dev/null
      done
    )

    if [[ ${#ALL_DRIVERS[@]} -eq 0 ]]; then
      warn "No HAL drivers found in:"
      printf '  - %s
' "${HAL_DIRS[@]}"
    else
      echo ""
      echo "Select drivers to remove (move to backup). Type numbers separated by spaces, or 'all'."
      echo ""
      i=1
      for drv in "${ALL_DRIVERS[@]}"; do
        echo "[$i] $drv"
        ((i++))
      done
      echo ""
      read -rp "Selection: " selection

      declare -a TARGETS=()
      if [[ "$selection" == "all" ]]; then
        TARGETS=("${ALL_DRIVERS[@]}")
      else
        for idx in $selection; do
          if [[ "$idx" =~ ^[0-9]+$ ]] && (( idx>=1 && idx<=${#ALL_DRIVERS[@]} )); then
            TARGETS+=("${ALL_DRIVERS[$((idx-1))]}")
          else
            warn "Skipping invalid index: $idx"
          fi
        done
      fi

      if [[ ${#TARGETS[@]} -eq 0 ]]; then
        warn "Nothing selected. Exiting."
        exit 0
      fi

      echo ""
      info "Dry run (what will be moved):"
      printf '  - %s → %s
' "${TARGETS[@]/#//}" "${BACKUP_DIR}/"
      echo ""
      read -rp "Proceed with move? (y/N): " yn
      if [[ "$yn" =~ ^[Yy]$ ]]; then
        APPLY=1
      else
        warn "Aborted by user."
        exit 0
      fi

      if [[ $APPLY -eq 1 ]]; then
        sudo mkdir -p "$BACKUP_DIR"
        for t in "${TARGETS[@]}"; do
          if [[ -e "$t" ]]; then
            sudo mv "$t" "$BACKUP_DIR/"
            good "Moved: $(basename "$t") → $BACKUP_DIR"
          fi
        done
      fi
    fi

    echo ""
    info "Resetting CoreAudio aggregate/multi-output devices…"
    defaults delete com.apple.audio.AggregateDevices 2>/dev/null || true
    defaults delete com.apple.audio.MultiOutputDevices 2>/dev/null || true

    echo ""
    info "Restarting CoreAudio…"
    sudo killall coreaudiod 2>/dev/null || true
    sleep 1

    echo ""
    list_virtual_devices
    echo ""
    good "Done. If an app re-installs its driver at launch (e.g., Loopback/ACE), remove or update that app."
    echo "Backup location: $BACKUP_DIR"
    echo "You can restore drivers by moving them back to /Library/Audio/Plug-Ins/HAL and restarting CoreAudio."
