#!/usr/bin/env bash
#/ Decrement a key's integer value.
#/
#/ Usage: kv-decrement <key>
#/
#/ Options:
#/    -h, --help      Print this help and exit
#/
#/ Examples:
#/    kv-decrement --help
#/    kv-decrement mycounter
set -euo pipefail
HERE="$(cd "$(dirname "$0")" && pwd)"
. "$HERE/../lib/envdb"

usage() {
  grep '^#/ ' <"$0" | cut -c4- | sed "s/\$(basename \"\$0\")/${0##*/}/g"
  exit 0
}

main() {
  # Check for help flags first
  if [ $# -eq 1 ] && [[ $1 == "-h" || $1 == "--help" ]]; then
    usage
  fi

  [ $# -eq 1 ] || {
    usage
    exit 2
  }
  init_db
  local key="$1" k v cur
  k=$(sql_escape "$key")
  local t
  t=$(key_type "$key" || true)
  if [ -z "${t:-}" ]; then
    cur=0
  elif [ "$t" != "string" ]; then
    wrongtype
  else
    v=$("$SQLITE_BIN" -batch -noheader -cmd 'PRAGMA foreign_keys=ON;' "$REDISQL_DB" "SELECT value FROM kv WHERE key='${k}' LIMIT 1;")
    cur=${v:-0}
  fi
  if ! [[ ${cur} =~ ^-?[0-9]+$ ]]; then die "value is not an integer or out of range"; fi
  cur=$((cur - 1))
  replace_with_string "$key" "$cur"
  echo "$cur"
}

main "$@"
