#!/usr/bin/env bash
#/ Restart coreaudiod when macOS audio is unresponsive.
#/
#/ Usage: $(basename "$0") [-h] [-v]
#/
#/ Available options:
#/    -h, --help      Print this help and exit
#/    -v, --verbose   Enable verbose output
#/
#/ Details:
#/    Finds the running coreaudiod PID and forcefully restarts it with sudo.

set -Eeuo pipefail
trap script.cleanup SIGINT SIGTERM ERR EXIT

source "$(dirname "$0")/../lib/bash/utils"

script_dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)

verbose=0

parse_args() {
  local remaining
  remaining=$(script.parse_common "$@")

  if [[ -n "$remaining" ]]; then
    log.error "This script does not accept positional arguments"
    script.usage 1
  fi
}

main() {
  (( verbose )) && log.info "Locating coreaudiod PID"

  local pid
  pid=$(pgrep -x coreaudiod || true)

  if [[ -z "$pid" ]]; then
    log.error "coreaudiod is not running"
    exit 1
  fi

  (( verbose )) && log.info "Restarting coreaudiod (pid: $pid)"
  sudo kill -9 "$pid"
  log.info "coreaudiod restart requested"
}

parse_args "$@"
main
